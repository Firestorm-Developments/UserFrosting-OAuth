{% set page_group = "loggedout" %}
<!DOCTYPE html>
<html lang="en">
    {% include 'common/components/head.html' %}
    <body>
        <div class="container">
            {% include 'common/components/main-nav.html' %}
            <div class="jumbotron">
                {% include 'common/components/alerts.html' %}
                <div class="row">
                    <div class="col-md-12">
                        <h4>Confirm {{oauth_provider}} registration</h4>
                        <h5>Hello {{oauth_details.name}}</h5>
                        <img src="{{oauth_details.imageUrl}}">
                        <img src="http://www.gravatar.com/avatar/{{oauth_details.email}}?s=32" />
                        <p class="lead">Review details below and confirm.</p>
                    </div>
                </div>


                <form  style="text-align:left;" name="oauth_register" method="post" action="{{site.uri.public}}/oauth/{{ oauth_provider|lower }}/settings/confirm" class="form-horizontal">
                    {% include 'common/components/csrf.html' %}
                    <div class="table-responsive">
                        <table class="table table-condensed">
                            <tr><th>Field</th><th>Value</th></tr>
                            {% for key,val in oauth_data %}
                            <tr>
                                <td >{{ key }}</td>
                                <td >{{ val }}</td>
                            </tr>
                            {% endfor %}        
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div>  
                                <button type="submit" name="btn_register" class="btn btn-success"  data-loading-text="Please wait..." >Register</button>
                            </div>
                        </div>
                    </div>
                    <div class="collapse">
                        <label>Spiderbro: Don't change me bro, I'm tryin'a catch some flies!</label>
                        <input name="spiderbro" id="spiderbro" value="http://"/>
                    </div>          
                </form>
            </div>	
        </div> <!-- /container -->
        {% include 'common/components/footer.html' %}
        <script>
            $(document).ready(function () {
                // Process form 
                $("form[name='register']").formValidation({
                framework: 'bootstrap',
                        // Feedback icons
                        icon: {
                        valid: 'fa fa-check',
                                invalid: 'fa fa-times',
                                validating: 'fa fa-refresh'
                        },
                        fields: {{ validators | raw }}
            }).on('success.form.fv', function (e) {
                // Prevent double form submission
                e.preventDefault();

                // Get the form instance
                var form = $(e.target);

                // Serialize and post to the backend script in ajax mode
                var serializedData = form.serialize();
                var url = form.attr('action');
                $.ajax({
                type: "POST",
                        url: url,
                        data: serializedData
                }).done(function (data, statusText, jqXHR) {
                    // Forward to login page on success
                    window.location.replace(site.uri.public + "/account/login");
                }).fail(function (jqXHR) {
                    if (site['debug'] == true) {
                        document.body.innerHTML = jqXHR.responseText;
                    } else {
                        console.log("Error (" + jqXHR.status + "): " + jqXHR.responseText);
                        // Display errors on failure
                        $('#userfrosting-alerts').flashAlerts().done(function () {
                            // Re-enable submit button
                            form.data('formValidation').disableSubmitButtons(false);
                            // Reload captcha
                            $("#captcha").captcha();
                        });
                    }
                });
                });
            });

            // This plugin reloads the captcha in the specified field
            (function ($) {
                $.fn.captcha = function () {
                    var field = $(this);
                    console.log("Reloading captcha");

                    var img_src = site.uri.public + "/account/captcha?" + new Date().getTime();

                    return $.ajax({
                        type: "GET",
                        url: img_src,
                        dataType: "text"
                    }).then(function (data, statusText, jqXHR) {  // Pass the deferral back
                        field.attr('src', data);
                        var target = field.data('target');
                        $(target).val("");
                        return data;
                    });
                };
            }(jQuery));
        </script>
    </body>
</html>
